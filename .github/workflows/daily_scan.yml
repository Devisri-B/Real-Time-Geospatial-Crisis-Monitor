name: Daily Crisis ETL

on:
  schedule:
    - cron: '0 */6 * * *' # Runs every 6 hours
  workflow_dispatch:      # Allows you to click "Run Now" manually

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # SPEED UPGRADE 1: Enable Caching here
      - name: Set up Python and Cache
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip' 

      # SPEED UPGRADE 2: Smart dependency installation
      # We move the spacy model download INTO the pip install step so it gets cached too.
      - name: Install Dependencies
        run: |
          pip install -r requirements.txt
          # Check if model exists before downloading to save bandwidth
          python -c "import spacy; spacy.load('en_core_web_sm')" || python -m spacy download en_core_web_sm

      - name: Run ETL Script
        env:
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
          DB_CONNECTION_STRING: ${{ secrets.DB_CONNECTION_STRING }}
        run: python etl_pipeline.py
